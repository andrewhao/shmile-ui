var CameraUtils=function(){};CameraUtils.snap=function(t,i){p.zoomFrame(t,"in"),p.modalMessage("Ready?",Config.ready_delay,200,function(){p.modalMessage("3",1e3,200,function(){p.modalMessage("2",1e3,200,function(){p.modalMessage("1",1e3,200,function(){i()})})})})},CameraUtils.scale4x6=function(t,i){var e=1.5,o=t/i;return e<=o?{w:6*i/4,h:i}:{w:t,h:4*t/6}},CameraUtils.scale4x1=function(t,i){var e=1.5,o=t/i;return e<=o?{w:4*i/6*.5,h:i}:{w:t,h:6*t/4*.5}};var Config={photo_margin:50,window_width:$(window).width(),window_height:$(window).height()-10,overlay_delay:2e3,next_delay:1e4,cheese_delay:400,flash_duration:1e3,ready_delay:2e3,nice_delay:5e3,between_snap_delay:1e3,is_mobile:!1},AppState=function(){this.reset()};AppState.prototype.reset=function(){this.current_frame_idx=0,this.zoomed=null};var ShmileStateMachine=function(t,i,e,o,n){this.photoView=t,this.socket=i,this.appState=e,this.config=o,this.buttonView=n;var s=this;this.fsm=StateMachine.create({initial:"loading",events:[{name:"connected",from:"loading",to:"ready"},{name:"ui_button_pressed",from:"ready",to:"waiting_for_photo"},{name:"photo_saved",from:"waiting_for_photo",to:"review_photo"},{name:"photo_updated",from:"review_photo",to:"next_photo"},{name:"continue_partial_set",from:"next_photo",to:"waiting_for_photo"},{name:"finish_set",from:"next_photo",to:"review_composited"},{name:"next_set",from:"review_composited",to:"ready"}],callbacks:{onconnected:function(){s.photoView.animate("in",function(){s.buttonView.fadeIn()})},onenterready:function(){s.photoView.resetState()},onleaveready:function(){},onenterwaiting_for_photo:function(t){cheeseCb=function(){s.photoView.modalMessage("Cheese!",s.config.cheese_delay),s.photoView.flashStart(),s.socket.emit("snap",!0)},CameraUtils.snap(s.appState.current_frame_idx,cheeseCb)},onphoto_saved:function(t,i,e,o){s.photoView.flashEnd(),s.photoView.updatePhotoSet(o.web_url,s.appState.current_frame_idx,function(){setTimeout(function(){s.fsm.photo_updated()},s.config.between_snap_delay)})},onphoto_updated:function(t,i,e){s.photoView.flashEnd(),3==s.appState.current_frame_idx?s.fsm.finish_set():(s.appState.current_frame_idx=(s.appState.current_frame_idx+1)%4,s.fsm.continue_partial_set())},onenterreview_composited:function(t,i,e){s.socket.emit("composite"),s.photoView.showOverlay(!0),setTimeout(function(){s.fsm.next_set()},s.config.next_delay)},onleavereview_composited:function(t,i,e){s.photoView.animate("out"),s.photoView.modalMessage("Nice!",s.config.nice_delay,200,function(){s.photoView.slideInNext()})},onchangestate:function(t,i,e){console.log("fsm received event "+t+", changing state from "+i+" to "+e)}}})},SocketProxy=function(){this.socket=null,this.fakeSocket={},_.extend(this.fakeSocket,Backbone.Events)};SocketProxy.prototype.lateInitialize=function(t){this.socket=t},SocketProxy.prototype.on=function(t,i){return null===this.socket?(console.log("SocketProxy 'on' delegating to fakeSocket"),void this.fakeSocket.on(t,i)):void this.socket.on(t,i)},SocketProxy.prototype.emit=function(t,i){return null===this.socket?(console.log("SocketProxy 'emit' delegating to fakeSocket"),void this.fakeSocket.trigger(t,function(){console.log(i)})):void this.socket.emit(t,i)};var SocketLayer=function(t,i){this.io=t,this.proxy=i};SocketLayer.prototype.init=function(){try{this.socket=this.io.connect("/"),this.proxy.lateInitialize(this.socket)}catch(t){console.log("Error initializing socket connection: "+t)}return this},SocketLayer.prototype.register=function(t){this.fsm=t;var i=this;this.proxy.on("message",function(t){console.log("message evt: data is:"+t)}),this.proxy.on("connect",function(){console.log("connected evt"),i.fsm.connected()}),this.proxy.on("camera_snapped",function(){console.log("camera_snapped evt")}),this.proxy.on("photo_saved",function(t){console.log("photo_saved evt: "+t.filename),i.fsm.photo_saved(t)})};var PhotoView=Backbone.View.extend({id:"#viewport",initialize:function(t,i){this.config=t,this.canvas=new Raphael("viewport",this.config.window_width,this.config.window_height),this.frames=this.canvas.set(),this.images=this.canvas.set(),this.all=this.canvas.set(),this.overlayImage=null,this.photoBorder=0,this.compositeDim=null,this.frameDim=null,this.compositeOrigin=null,this.compositeCenter=null,this.state=i},render:function(){var t=this.config.window_width-this.config.photo_margin,i=this.config.window_height-this.config.photo_margin;this.compositeDim=CameraUtils.scale4x1(t,i),this.compositeOrigin={x:(this.config.window_width-this.compositeDim.w)/2,y:(this.config.window_height-this.compositeDim.h)/2},this.compositeCenter={x:this.compositeOrigin.x+this.compositeDim.w/2,y:this.compositeOrigin.y+this.compositeDim.h/2};var e=this.canvas.rect(this.compositeOrigin.x,this.compositeOrigin.y,this.compositeDim.w,this.compositeDim.h);e.attr({fill:"white"}),this.all.push(e),this.photoBorder=this.compositeDim.w/50;var o=this.compositeOrigin.x+this.photoBorder,n=this.compositeOrigin.y+this.photoBorder,s=this.compositeDim.w-2*this.photoBorder;this.frameDim={w:this.compositeDim.w-2*this.photoBorder,h:4*s/6};var a=this.canvas.rect(o,n,this.frameDim.w,this.frameDim.h);a.attr({fill:"black"});var h=this.canvas.image(null,o,n,this.frameDim.w,this.frameDim.h);this.images.push(h),this.frames.push(a),this.all.push(h),this.all.push(a);for(var r=0;r<3;r++)a=a.clone(),h=h.clone(),a.translate(0,this.frameDim.h+this.photoBorder),h.translate(0,this.frameDim.h+this.photoBorder),this.frames.push(a),this.images.push(h),this.all.push(a),this.all.push(h);var c=this.canvas.image("/images/overlay_david.png",this.compositeOrigin.x,this.compositeOrigin.y,this.compositeDim.w,this.compositeDim.h);this.all.push(c),this.overlayImage=c,this.all.hide(),this.all.translate(-this.config.window_width,0)},toString:function(){return ret=[],ret.push("Size of 'all' set: "+this.all.length),ret.push("Size of 'frames' set: "+this.frames.length),ret.push("Composite photo is: "+this.all[0].attr("width")+"x"+this.all[0].attr("height")),ret.push("Frame photo is: "+this.frameDim.w+"x"+this.frameDim.h),ret.join("\n")},updatePhotoSet:function(t,i,e){var o=this,n=o.images[i],s=o.frames[i];n.attr({src:t,opacity:0}),n.show();var a=function(){s.hide(),p.zoomFrame(i,"out",e)};n.animate({opacity:1},200,a)},animate:function(t,i){"in"===t?(this.all.show(),this.images.hide(),this.overlayImage.hide(),this.all.animate({translation:this.config.window_width+",0"},1e3,"<>",i)):"out"===t&&this.all.animate({translation:this.config.window_width+",0"},1e3,"<>",i)},zoomFrame:function(t,i,e){var o=this,n=(this.all[t],this.frames[t]),s=n.attr("x"),a=n.attr("width"),h=n.attr("y"),r=n.attr("height"),c=s+a/2,m=h+r/2,l=1e3,f=this.compositeCenter.x-c,p=this.compositeCenter.y-m,d=this.compositeDim.h/this.frameDim.h;"out"===i&&this.state.zoomed?(d=1,f=-this.state.zoomed.dx,p=-this.state.zoomed.dy,o.all.animate({scale:[1,1,o.compositeCenter.x,o.compositeCenter.y].join(",")},l,"bounce",function(){o.all.animate({translation:f+","+p},l,"<>",e)}),this.state.zoomed=null):"out"!==i&&(o.all.animate({translation:f+","+p},l,"<>",function(){o.all.animate({scale:[d,d,o.compositeCenter.x,o.compositeCenter.y].join(",")},l,"bounce",e)}),this.state.zoomed={dx:f,dy:p,scaleFactor:d})},slideInNext:function(){this.resetState(),this.modalMessage("Next!"),this.all.hide(),this.all.translate(2*-this.config.window_width,0),this.animate("in",function(){$("#start-button").fadeIn()})},resetState:function(){this.state.reset()},flashEffect:function(t){void 0===t&&(t=200);var i=this.canvas.rect(0,0,this.config.window_width,this.config.window_height);i.attr({fill:"white",opacity:0}),i.animate({opacity:1},t,">",function(){i.animate({opacity:0},t,"<"),i.remove()})},flashStart:function(t){void 0===t&&(t=200),this.rect=this.canvas.rect(0,0,this.config.window_width,this.config.window_height),this.rect.attr({fill:"white",opacity:0}),this.rect.animate({opacity:1},t,">")},flashEnd:function(t){void 0===t&&(t=200);var i=this;this.rect.animate({opacity:0},t,"<",function(){i.remove()})},modalMessage:function(t,i,e,o){if(void 0===e)var e=200;if(void 0===i)var i=500;var n=.3*this.config.window_height,s=(this.config.window_width-n)/2,a=(this.config.window_height-n)/2,h=this.canvas.set(),r=this.canvas.rect(s,a,n,n,15);r.attr({fill:"#222","fill-opacity":.7,"stroke-color":"white"}),h.push(r);var c=this.canvas.text(s+n/2,a+n/2,t);c.attr({fill:"white","font-size":"50","font-weight":"bold"}),h.push(c),h.attr({opacity:0}),h.animate({opacity:1,scale:"1.5,1.5","font-size":"70"},e,">");setTimeout(function(t){c.remove(),r.remove(),o&&o()},i,h)},showOverlay:function(t){this.overlayImage.show(),t&&this.overlayImage.animate({opacity:1},this.config.overlay_delay)},hideOverlay:function(t){var i=this;t?this.overlayImage.animate({opacity:0},this.config.overlay_delay,function(){i.overlayImage.hide()}):this.overlayImage.hide()}}),ButtonView=function(t){this.fsm=t};ButtonView.prototype.render=function(){var t=this;this.startButton=$("button#start-button");var i=(Config.window_width-this.startButton.outerWidth())/2,e=(Config.window_height-this.startButton.outerHeight())/2;this.startButton.hide(),this.startButton.css({top:e,left:i});var o=Config.is_mobile?"touchend":"click";this.startButton.bind(o,function(t){var i=$(t.currentTarget);i.fadeOut(1e3),$(document).trigger("ui_button_pressed")}),$(document).bind("ui_button_pressed",function(){console.log("ui_button_pressed evt"),t.fsm.ui_button_pressed()})},ButtonView.prototype.fadeIn=function(){this.startButton.fadeIn()},$(window).ready(function(){var t=new SocketProxy,i=new AppState;window.io=window.io||void 0,window.p=new PhotoView(window.Config,i),bv=new ButtonView;var e=new ShmileStateMachine(window.p,t,i,window.Config,bv);bv.fsm=e.fsm;var o=new SocketLayer(window.io,t);o.init(),o.register(e.fsm),window.socketProxy=t,bv.render(),p.render()});
//# sourceMappingURL=../maps/shmile-ui.js.map
